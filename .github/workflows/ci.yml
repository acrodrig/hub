# See https://deno.land/manual/advanced/continuous_integration

on: [push,pull_request]

# Set DENO_DIR to an absolute or relative path on the runner.
# gh secret set DENO_AUTH_TOKENS --body "$DENO_AUTH_TOKENS"
# gh secret set CODECOV_TOKEN --body "$CODECOV_TOKEN"
# gh secret set GOOGLE_CREDENTIALS < manager.json

env:
  DENO_AUTH_TOKENS: ${{ secrets.DENO_AUTH_TOKENS }}
  DENO_DIR: .cache

jobs:

  build:
    runs-on: ubuntu-latest
    steps:
      # Debug
      # - { name: "üêû Debug Github Context", uses: "echo '${{ toJson(github) }}'" }

      # Checkout and test
      - { name: "üîΩ Checkout code", uses: "actions/checkout@v4" }
      - { name: "‚öôÔ∏è Setup Deno", uses: "denoland/setup-deno@v2" }
      - { name: "üß™ Running Tests", run: "deno test --allow-all --coverage=cov/" }
      - { name: "üîÄ Transforming Coverage Format", run: "deno coverage --lcov cov/ > cov.lcov" }
      - { name: "üé® Ensuring code is formatted correctly", run: "deno fmt --check" }

      # Upload to Codecov (see https://github.com/marketplace/actions/codecov)
      - name: "‚òÇÔ∏è Upload Test Coverage"
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: cov.lcov
          slug: acrodrig/hub
          fail_ci_if_error: true

  publish:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - { name: "üîΩ Checkout code", uses: "actions/checkout@v4" }
      - { name: "‚öôÔ∏è Setup Deno", uses: "denoland/setup-deno@v2" }
      - { name: "üì¶ Publish to JSR", uses: "deno publish" }
